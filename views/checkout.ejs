<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('partials/head') %>
    <title>Checkout</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container py-5">
      <h2 class="mb-4 text-center">Checkout</h2>
      <% if (total > 0) { %>
      <form action="/order/create" method="POST" id="checkoutForm" class="shadow p-4 rounded bg-light">
        <input type="hidden" id="totalAmount" value="<%= total %>" />
        <% if (currency == 'NGN') { %>
        <label for="total" class="form-label fw-bold fs-5">Total Amount: &#8358;</label>
        <input id="total" class="fw-bold form-control-lg fs-5 text-secondary" name="total" value="<%= total %>" readonly />
        <% } else { %>
        <label for="total" class="form-label fw-bold fs-5">Total Amount: $</label>
        <input id="total" class="fw-bold form-control-lg fs-5 text-secondary" name="total" value="<%= total %>" readonly />
        <% } %>

        <input type="hidden" id="currency" value="<%= currency %>" name="currency" />

        <div class="mt-3">
          <label for="phoneNumber" class="form-label fw-bold fs-5">Phone Number</label>
          <input id="phoneNumber" name="phoneNumber" class="form-control-lg ms-2" required />
        </div>

        <h5 class="fs-4 mb-3">Delivery Options</h5>
        <div class="form-check mb-2">
          <input type="radio" name="deliveryMethod" value="pickup" onchange="updateTotal()" class="form-check-input" />
          <label class="form-check-label fs-5">Pickup (No additional cost)</label>
        </div>

        <div class="form-check">
          <input type="radio" name="deliveryMethod" value="delivery" onchange="updateTotal()" class="form-check-input" />
          <label class="form-check-label fs-5">Delivery</label>
        </div>

        <div id="deliveryMethods" class="mt-3" style="margin-left: 20px">
          <label for="location" class="form-label fs-5">Location:</label>
          <select name="location" class="form-select form-select-sm" onchange="updateTotal()">
            <% deliveryPrices.forEach((price) => { %>
              <option value="<%= price.location %>" data-ngn="<%= price.NGNprice %>" data-usd="<%= price.USDprice %>">
                <%= price.location %>
              </option>
            <% }); %>
          </select>

          <div id="addressInput" class="mt-3" style="display: none">
            <label for="deliveryAddress" class="form-label">Delivery Address:</label>
            <textarea
              name="deliveryAddress"
              class="form-control"
              placeholder="Enter your delivery address"
              required
            ></textarea>
          </div>
        </div>

        <button type="submit" class="btn btn-dark mt-4 w-100">Pay Now</button>
      </form>
      <% } else { %>
      <div class="text-center">
        <p class="text-danger">Your cart is empty.</p>
        <a href="/shop" class="btn btn-primary">Shop Now</a>
      </div>
      <% } %>
    </div>

    <%- include('partials/footer') %>

    <script>
      const totalAmount = parseFloat(document.getElementById("totalAmount").value);
      const addressInput = document.getElementById("addressInput");
      const addressField = document.querySelector('textarea[name="deliveryAddress"]');
      const currency = document.getElementById("currency").value;

      function updateTotal() {
        const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
        const locationSelect = document.querySelector('select[name="location"]');
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        let newTotal = totalAmount;

        if (deliveryMethod === "delivery") {
          const deliveryPrice = currency === "NGN" 
            ? parseFloat(selectedOption.getAttribute("data-ngn")) 
            : parseFloat(selectedOption.getAttribute("data-usd"));
          newTotal += deliveryPrice;

          addressInput.style.display = "block";
          addressField.required = true;
        } else {
          addressInput.style.display = "none";
          addressField.required = false;
        }

        document.getElementById("total").value = newTotal.toFixed(2);
      }
    </script>
  </body>
</html>
